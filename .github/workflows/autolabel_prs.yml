name: Auto-Label PRs

on:
  pull_request_target:
    types: [opened, synchronize]

jobs:
  label-and-milestone:
    runs-on: ubuntu-latest
    steps:
    - name: Set label and milestone
      id: set-label-milestone
      uses: actions/github-script@v7
      with:
        script: |
          const completionsLabel = 'completions';

          // Get changed files in the pull request
          const prNumber = context.payload.pull_request.number;
          const { data: files } = await github.rest.pulls.listFiles({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: prNumber,
          });

          // Check if any file matches /share/completions/*.fish and no change is outside of /share/
          const completionsRegex = new RegExp('^share/completions/.*\.fish');
          const isCompletions = files.some(file => completionsRegex.test(file.filename))
            && files.every(file => file.filename.startsWith('share/'));

          if (isCompletions) {
            // Add label to PR
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: [completionsLabel],
            });
            console.log(`PR ${prNumber} assigned label "${completionsLabel}"`);
          }
